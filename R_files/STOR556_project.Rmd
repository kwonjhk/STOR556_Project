---
title: "STOR556 Project Main"
output: html_notebook
---

```{r}
#import necessary packages
library(readr)
library(itsmr)
#import R scripts
source("~/Documents/differencing.R")
source("~/Documents/stationarizing.R")
#import data from local file
co2_data <- read_table2("~/Downloads/co2_data.txt")
x <- c(co2_data$interpolated)
#plots of the initial time series
plot(x, type="l", xlab="t", ylab=expression("X"["t"]*" (ppm)"), main=expression("Carbon Dioxide Time Series X"["t"]))
plota(x)
```

```{r}
#use differencing function to remove seasonality and trend
x.diff = differencing(x, 12, 1)
#use autofit function to fit an arma to the stationary residuals
x.diff.arma = autofit(x.diff, 0:5, 0:5)
x.diff.resid = Resid(x.diff, NULL, x.diff.arma)
#plot and test the new residuals
plot(x.diff.resid, 
     type="l", 
     xlab="t", 
     ylab="residuals", 
     main="Plot of residuals after fitting ARMA(p,q)")
plota(x.diff.resid)
test(x.diff.resid)
```

```{r}
#stationarize by deseasonlizing and subtracting fitted quadratic polynomial
u = stationarizing(x, 12, 2)
#use autofit function to fit an arma to the stationary residuals
r.arma = autofit(u, 0:5, 0:5)
r = Resid(u, NULL, r.arma)
#plot and test the new residuals
plot(r, 
     type="l", 
     xlab="t", 
     ylab=expression("r"["t"]), 
     main=expression("Plot of r"["t"]))
plota(r)
test(r)
```
```{r}
#95% and 99% CI for November 2019 prediction
a=forecast(x, c("season", 12, "trend", 2), r.arma, h=1, opt=1, alpha=.05)
b=forecast(x, c("season", 12, "trend", 2), r.arma, h=1, opt=1, alpha=.01)
```

```{r}
#Create estimation dataset x.1
x.p = c(x[c(1:length(x))], a$pred[1])
#xhat is the t value (index in Xt) of November 2019
xhat = length(x.p)

#plotting 95% and 99% confidence intervals
plot(c(720:xhat), x.p[c(720:xhat)], type="l", ylim=c(406, 415), main="95% CI for November 2019 Prediction", ylab=expression("X"["t"]*" (ppm)"), xlab="t")
plotCI(xhat, a$pred[1], ui=a$u[1], li=a$l[1], gap=0, col="red", add=TRUE)

plot(c(720:xhat), x.p[c(720:xhat)], type="l", ylim=c(406, 415), main="99% CI for November 2019 Prediction", ylab=expression("X"["t"]*" (ppm)"), xlab="t")
plotCI(xhat, b$pred[1], ui=b$u[1], li=b$l[1], col="blue", gap = 0, add=TRUE)

plot(c(720:xhat), x.p[c(720:xhat)], type="l", ylim=c(406, 415), main="95% and 99% CI for November 2019 Prediction", ylab=expression("X"["t"]*" (ppm)"), xlab="t")
plotCI(xhat, a$pred[1], ui=a$u[1], li=a$l[1], gap=0, col="red", add=TRUE)
plotCI(xhat, b$pred[1], ui=b$u[1], li=b$l[1], gap=0, col="blue", add=TRUE)
```
